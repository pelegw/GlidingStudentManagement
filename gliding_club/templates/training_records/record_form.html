{% extends 'base.html' %}
{% load i18n %}
{% block title %}
    {% if object %}
        {% trans "Edit" %}
    {% else %}
        {% trans "New" %}
    {% endif %}
    {% trans "Training Record" %} - {{ CLUB_NAME }}
{% endblock %}

{% block extra_css %}
<style nonce="{{ csp_nonce }}">
    /* Additional styles for the exercise items */
    .exercise-quick-item {
        transition: background-color 0.2s;
    }
    
    .exercise-quick-item:hover {
        background-color: rgba(0, 123, 255, 0.05);
    }
    
    /* Highlight selected exercises */
    .quick-select-checkbox:checked + label {
        font-weight: bold;
        color: #0d6efd;
    }
    
    /* Hide not-performed exercises in detailed mode when filter is active */
    .hide-not-performed .exercise-item.not-performed {
        display: none !important;
    }
    
    /* Filter toggle button styling */
    .filter-badge {
        cursor: pointer;
        user-select: none;
    }
    
    .filter-badge.active {
        background-color: #198754 !important;
    }
    
    /* Form design improvements */
    .card {
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }
    
    .card-header {
        padding: 1rem;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    .card-body {
        padding: 1.25rem;
    }
    
    .form-label {
        font-weight: 500;
        margin-bottom: 0.5rem;
    }
    
    .form-select, .form-control {
        padding: 0.5rem 0.75rem;
        border-radius: 0.375rem;
        border: 1px solid #ced4da;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    
    .form-select:focus, .form-control:focus {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    
    .input-group-text {
        background-color: #f8f9fa;
        border: 1px solid #ced4da;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">
                {% if object %}
                    {% trans "Edit" %}
                {% else %}
                    {% trans "New" %}
                {% endif %}
                {% trans "Training Record" %}
            </h4>
            <p class="text-light mb-0 small">{% trans "Record details about your flight training session" %}</p>
        </div>
        <div class="card-body">
            <form method="post" id="recordForm">
                {% csrf_token %}
                
                <!-- Flight Information Section -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">{% trans "Flight Information" %}</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="mb-2">
                                    <label for="{{ form.instructor.id_for_label }}" class="form-label fw-bold d-block">
                                        {% trans "Instructor" %}
                                    </label>
                                </div>
                                {{ form.instructor }}
                                {% if form.instructor.errors %}
                                    <div class="text-danger">{{ form.instructor.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-2">
                                    <label for="{{ form.date.id_for_label }}" class="form-label fw-bold d-block">
                                        {% trans "Date" %}
                                    </label>
                                </div>
                                {{ form.date }}
                                {% if form.date.errors %}
                                    <div class="text-danger">{{ form.date.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-2">
                                    <label for="{{ form.glider.id_for_label }}" class="form-label fw-bold d-block">
                                        {% trans "Glider" %}
                                    </label>
                                </div>
                                {{ form.glider }}
                                {% if form.glider.errors %}
                                    <div class="text-danger">{{ form.glider.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        </div>
                        
                        <!-- Row 2: Flight Duration, Tow Height, Field/Location - With title above the field -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="mb-2">
                                    <label for="{{ form.duration_display.id_for_label }}" class="form-label fw-bold d-block">
                                        {% trans "Flight Duration" %}
                                    </label>
                                </div>
                                <div class="input-group">
                                    {{ form.duration_display }}
                                    <span class="input-group-text">HH:MM</span>
                                </div>
                                {% if form.duration_display.errors %}
                                    <div class="text-danger">{{ form.duration_display.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-2">
                                    <label for="{{ form.tow_height.id_for_label }}" class="form-label fw-bold d-block">
                                        {% trans "Tow Height" %}
                                    </label>
                                </div>
                                <div class="input-group">
                                    {{ form.tow_height }}
                                    <span class="input-group-text">feet</span>
                                </div>
                                {% if form.tow_height.errors %}
                                    <div class="text-danger">{{ form.tow_height.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-2">
                                    <label for="{{ form.field.id_for_label }}" class="form-label fw-bold d-block">
                                        {% trans "Field/Location" %}
                                    </label>
                                </div>
                                {{ form.field }}
                                {% if form.field.errors %}
                                    <div class="text-danger">{{ form.field.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Row 3: Training Topic and Solo Flight - Better aligned -->
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <div class="mb-2">
                                    <label for="{{ form.training_topic.id_for_label }}" class="form-label fw-bold d-block">
                                        {% trans "Training Topic" %}
                                    </label>
                                </div>
                                {{ form.training_topic }}
                                {% if form.training_topic.errors %}
                                    <div class="text-danger">{{ form.training_topic.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-2">
                                </div>
                                <div class="form-check">
                                    {{ form.is_solo }}
                                    <label class="form-check-label" for="{{ form.is_solo.id_for_label }}">
                                        {% trans "Solo Flight" %}
                                    </label>
                                    
                                    {% if form.is_solo.errors %}
                                        <div class="text-danger">{{ form.is_solo.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        </div>
                    </div>
                </div>
                
                <!-- Exercises Section with Quick Select Feature -->
                <div class="card mb-4">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 d-flex align-items-center">
                            {% trans "Exercises Performed" %}
                            <span id="exercise-counter" class="badge bg-secondary ms-2">0</span>
                            
                            <!-- New filter toggle that shows in detailed mode -->
                            <span id="filter-toggle" class="badge bg-light text-dark border ms-3 filter-badge active">
                                <i class="bi bi-funnel-fill"></i> {% trans "Show Only Selected" %}
                            </span>
                        </h5>
                        
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm btn-outline-primary" id="btn-quick-select-mode">{% trans "Quick Select Mode" %}</button>
                            <button type="button" class="btn btn-sm btn-outline-primary d-none" id="btn-detailed-mode">{% trans "Detailed Mode" %}</button>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="btn-expand-all">{% trans "Expand All" %}</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-collapse-all">{% trans "Collapse All" %}</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Quick select introduction and help text -->
                        <div id="quick-select-help" class="alert alert-info mb-3 d-none">
                            <p><strong>{% trans "Quick Select Mode:" %}</strong> {% trans "Check only the exercises you performed during this flight. Unselected exercises will automatically be marked as 'Not Performed'." %}</p>
                            <p>{% trans "For exercises you select, you can provide a detailed assessment in the next step." %}</p>
                        </div>
                        
                        <!-- Search box -->
                        <div class="input-group mb-3">
                            <span class="input-group-text">
                                <i class="bi bi-search"></i>
                            </span>
                            <input type="text" class="form-control" id="exercise-search" placeholder="{% trans 'Search exercises...' %}">
                        </div>
                        
                        <!-- Navigation tabs for Pre/Post solo exercises -->
                        <ul class="nav nav-tabs mb-3" id="exerciseTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="pre-solo-tab" data-bs-toggle="tab" data-bs-target="#pre-solo-exercises" 
                                        type="button" role="tab" aria-controls="pre-solo-exercises" aria-selected="true">
                                    Pre-Solo ({{ pre_solo_exercises.count }})
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="post-solo-tab" data-bs-toggle="tab" data-bs-target="#post-solo-exercises" 
                                        type="button" role="tab" aria-controls="post-solo-exercises" aria-selected="false">
                                    Post-Solo ({{ post_solo_exercises.count }})
                                </button>
                            </li>
                        </ul>

                        <!-- Quick Select Mode UI -->
                        <div id="quick-select-mode" class="d-none">
                            <div class="tab-content" id="quickSelectTabContent">
                                <!-- Pre-Solo Quick Select -->
                                <div class="tab-pane fade show active" id="quick-pre-solo" role="tabpanel" aria-labelledby="pre-solo-tab">
                                    <div class="card">
                                        <div class="card-header bg-light">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <h6 class="mb-0">{% trans "Pre-Solo Exercises" %}</h6>
                                                <div>
                                                    <button type="button" class="btn btn-sm btn-outline-primary select-all-btn" data-target="pre-solo">{% trans "Select All" %}</button>
                                                    <button type="button" class="btn btn-sm btn-outline-secondary deselect-all-btn" data-target="pre-solo">{% trans "Deselect All" %}</button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                {% for exercise in pre_solo_exercises %}
                                                <div class="col-md-6 col-lg-4 exercise-quick-item" data-exercise-id="{{ exercise.id }}" data-exercise-name="{{ exercise.name }}">
                                                    <div class="form-check mb-2">
                                                        <input class="form-check-input quick-select-checkbox" type="checkbox" id="quick-select-{{ exercise.id }}" data-exercise-id="{{ exercise.id }}" data-category="pre-solo">
                                                        <label class="form-check-label" for="quick-select-{{ exercise.id }}">
                                                            {% if exercise.number %}{{ exercise.number }} - {% endif %}{{ exercise.name }}
                                                        </label>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Post-Solo Quick Select -->
                                <div class="tab-pane fade" id="quick-post-solo" role="tabpanel" aria-labelledby="post-solo-tab">
                                    <div class="card">
                                        <div class="card-header bg-light">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <h6 class="mb-0">{% trans "Post-Solo Exercises" %}</h6>
                                                <div>
                                                    <button type="button" class="btn btn-sm btn-outline-primary select-all-btn" data-target="post-solo">{% trans "Select All" %}</button>
                                                    <button type="button" class="btn btn-sm btn-outline-secondary deselect-all-btn" data-target="post-solo">{% trans "Deselect All" %}</button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                {% for exercise in post_solo_exercises %}
                                                <div class="col-md-6 col-lg-4 exercise-quick-item" data-exercise-id="{{ exercise.id }}" data-exercise-name="{{ exercise.name }}">
                                                    <div class="form-check mb-2">
                                                        <input class="form-check-input quick-select-checkbox" type="checkbox" id="quick-select-{{ exercise.id }}" data-exercise-id="{{ exercise.id }}" data-category="post-solo">
                                                        <label class="form-check-label" for="quick-select-{{ exercise.id }}">
                                                            {% if exercise.number %}{{ exercise.number }} - {% endif %}{{ exercise.name }}
                                                        </label>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2 mt-3">
                                <button type="button" id="apply-quick-select" class="btn btn-primary">{% trans "Apply Selection & Continue" %}</button>
                            </div>
                        </div>
                        
                        <!-- Tab content for detailed mode -->
                        <div class="tab-content" id="exerciseTabContent">
                            <!-- Pre-Solo Exercises Tab -->
                            <div class="tab-pane fade show active" id="pre-solo-exercises" role="tabpanel" aria-labelledby="pre-solo-tab">
                                <div class="list-group">
                                    {% for exercise in pre_solo_exercises %}
                                        <div class="list-group-item list-group-item-action mb-2 exercise-item"
                                             data-exercise-id="{{ exercise.id }}"
                                             data-exercise-name="{{ exercise.name }}">
                                            <div class="d-flex w-100 justify-content-between align-items-center exercise-header">
                                                <h6 class="mb-1">
                                                    {% if exercise.number %}{{ exercise.number }} - {% endif %}{{ exercise.name }}
                                                </h6>
                                                <div>
                                                    <span class="badge exercise-status bg-secondary">Not Performed</span>
                                                    <button type="button" class="btn btn-sm btn-outline-secondary ms-2 exercise-toggle">
                                                        <i class="bi bi-chevron-down"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <div class="exercise-content mt-2 d-none">
                                                <input type="hidden" name="form-{{ forloop.counter0 }}-exercise" value="{{ exercise.id }}">
                                                
                                                <div class="btn-group w-100 mb-3" role="group">
                                                    <input type="radio" class="btn-check" name="form-{{ forloop.counter0 }}-performance" 
                                                           id="form-{{ forloop.counter0 }}-not_performed" value="not_performed" checked>
                                                    <label class="btn btn-outline-secondary" for="form-{{ forloop.counter0 }}-not_performed">
                                                        {% trans "Not Performed" %}
                                                    </label>

                                                    <input type="radio" class="btn-check" name="form-{{ forloop.counter0 }}-performance" 
                                                           id="form-{{ forloop.counter0 }}-performed_badly" value="performed_badly">
                                                    <label class="btn btn-outline-danger" for="form-{{ forloop.counter0 }}-performed_badly">
                                                        {% trans "Performed Badly" %}
                                                    </label>

                                                    <input type="radio" class="btn-check" name="form-{{ forloop.counter0 }}-performance" 
                                                           id="form-{{ forloop.counter0 }}-needs_improvement" value="needs_improvement">
                                                    <label class="btn btn-outline-warning" for="form-{{ forloop.counter0 }}-needs_improvement">
                                                        {% trans "Needs Improvement" %}
                                                    </label>
                                                    
                                                    <input type="radio" class="btn-check" name="form-{{ forloop.counter0 }}-performance" 
                                                           id="form-{{ forloop.counter0 }}-performed_well" value="performed_well">
                                                    <label class="btn btn-outline-success" for="form-{{ forloop.counter0 }}-performed_well">
                                                        {% trans "Performed Well" %}
                                                    </label>
                                                </div>
                                                
                                               <!-- <div class="notes-container d-none">
                                                    <textarea name="form-{{ forloop.counter0 }}-notes" class="form-control" rows="2" 
                                                              placeholder="{% trans 'Optional notes about this exercise' %}"></textarea>
                                                </div> -->
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <!-- Post-Solo Exercises Tab -->
                            <div class="tab-pane fade" id="post-solo-exercises" role="tabpanel" aria-labelledby="post-solo-tab">
                                <div class="list-group">
                                    {% for exercise in post_solo_exercises %}
                                        <div class="list-group-item list-group-item-action mb-2 exercise-item"
                                             data-exercise-id="{{ exercise.id }}"
                                             data-exercise-name="{{ exercise.name }}">
                                            <div class="d-flex w-100 justify-content-between align-items-center exercise-header">
                                                <h6 class="mb-1">
                                                    {% if exercise.number %}{{ exercise.number }} - {% endif %}{{ exercise.name }}
                                                </h6>
                                                <div>
                                                    <span class="badge exercise-status bg-secondary">Not Performed</span>
                                                    <button type="button" class="btn btn-sm btn-outline-secondary ms-2 exercise-toggle">
                                                        <i class="bi bi-chevron-down"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <div class="exercise-content mt-2 d-none">
                                                <input type="hidden" name="form-{{ forloop.counter0|add:pre_solo_exercises.count }}-exercise" value="{{ exercise.id }}">
                                                
                                                <div class="btn-group w-100 mb-3" role="group">
                                                    <input type="radio" class="btn-check" name="form-{{ forloop.counter0|add:pre_solo_exercises.count }}-performance" 
                                                           id="form-{{ forloop.counter0|add:pre_solo_exercises.count }}-not_performed" value="not_performed" checked>
                                                    <label class="btn btn-outline-secondary" for="form-{{ forloop.counter0|add:pre_solo_exercises.count }}-not_performed">
                                                        {% trans "Not Performed" %}
                                                    </label>

                                                    <input type="radio" class="btn-check" name="form-{{ forloop.counter0|add:pre_solo_exercises.count }}-performance" 
                                                           id="form-{{ forloop.counter0|add:pre_solo_exercises.count }}-performed_badly" value="performed_badly">
                                                    <label class="btn btn-outline-danger" for="form-{{ forloop.counter0|add:pre_solo_exercises.count }}-performed_badly">
                                                        {% trans "Performed Badly" %}
                                                    </label>
                                                    <input type="radio" class="btn-check" name="form-{{ forloop.counter0|add:pre_solo_exercises.count }}-performance" 
                                                           id="form-{{ forloop.counter0|add:pre_solo_exercises.count }}-needs_improvement" value="needs_improvement">
                                                    <label class="btn btn-outline-warning" for="form-{{ forloop.counter0|add:pre_solo_exercises.count }}-needs_improvement">
                                                        {% trans "Needs Improvement" %}
                                                    </label>
                                                    
                                                    <input type="radio" class="btn-check" name="form-{{ forloop.counter0|add:pre_solo_exercises.count }}-performance" 
                                                           id="form-{{ forloop.counter0|add:pre_solo_exercises.count }}-performed_well" value="performed_well">
                                                    <label class="btn btn-outline-success" for="form-{{ forloop.counter0|add:pre_solo_exercises.count }}-performed_well">
                                                        {% trans "Performed Well" %}
                                                    </label>
                                                </div>
                                                
                                               <!-- <div class="notes-container d-none">
                                                    <textarea name="form-{{ forloop.counter0|add:pre_solo_exercises.count }}-notes" class="form-control" rows="2" 
                                                              placeholder="{% trans 'Optional notes about this exercise' %}"></textarea>
                                                </div> -->
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Management form fields for formset -->
                        <input type="hidden" name="form-TOTAL_FORMS" value="{{ pre_solo_exercises.count|add:post_solo_exercises.count }}">
                        <input type="hidden" name="form-INITIAL_FORMS" value="0">
                        <input type="hidden" name="form-MIN_NUM_FORMS" value="0">
                        <input type="hidden" name="form-MAX_NUM_FORMS" value="1000">
                    </div>
                </div>
                
                <!-- Comments Section -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">{% trans "Comments" %}</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="{{ form.student_comments.id_for_label }}" class="form-label">
                                {% trans "Student Comments" %}:
                            </label>
                            {{ form.student_comments }}
                            {% if form.student_comments.errors %}
                                <div class="text-danger">{{ form.student_comments.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Form errors -->
                {% if form.errors %}
                    <div class="alert alert-danger">
                        <p><strong>Please correct the following errors:</strong></p>
                        <ul>
                            {% for field in form %}
                                {% for error in field.errors %}
                                    <li>{{ field.label }}: {{ error }}</li>
                                {% endfor %}
                            {% endfor %}
                            {% for error in form.non_field_errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}
                
                <!-- Submit buttons -->
                <div class="d-flex justify-content-between">
                    <a href="{% url 'record_list' %}" class="btn btn-secondary">{% trans "Cancel" %}</a>
                    <button type="submit" class="btn btn-primary">
                        {% if object %}
                            {% trans "Save Changes" %}
                        {% else %}
                            {% trans "Create Record" %}
                        {% endif %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script nonce="{{ csp_nonce }}">
document.addEventListener('DOMContentLoaded', function() {
    // Mode switching
    const quickSelectMode = document.getElementById('quick-select-mode');
    const quickSelectHelp = document.getElementById('quick-select-help');
    const detailedMode = document.getElementById('exerciseTabContent');
    const btnQuickMode = document.getElementById('btn-quick-select-mode');
    const btnDetailedMode = document.getElementById('btn-detailed-mode');
    const searchInput = document.getElementById('exercise-search');
    const exerciseTabs = document.getElementById('exerciseTabs');
    const expandAllBtn = document.getElementById('btn-expand-all');
    const collapseAllBtn = document.getElementById('btn-collapse-all');
    const filterToggle = document.getElementById('filter-toggle');
    
    // Apply filter container class to exercise tabs parent
    const exerciseTabsContainer = document.getElementById('exerciseTabContent');
    exerciseTabsContainer.classList.add('hide-not-performed');
    
    // Tab panes
    const preSoloTab = document.getElementById('pre-solo-tab');
    const postSoloTab = document.getElementById('post-solo-tab');
    const quickPreSoloTab = document.getElementById('quick-pre-solo');
    const quickPostSoloTab = document.getElementById('quick-post-solo');
    
    // Filter toggle functionality
    if (filterToggle) {
        filterToggle.addEventListener('click', function() {
            this.classList.toggle('active');
            exerciseTabsContainer.classList.toggle('hide-not-performed');
            
            // Update icon and text based on state
            if (this.classList.contains('active')) {
                this.innerHTML = '<i class="bi bi-funnel-fill"></i> {% trans "Show Only Selected" %}';
            } else {
                this.innerHTML = '<i class="bi bi-funnel"></i> {% trans "Show All" %}';
            }
        });
    }
    
    // Mode switching functions
    btnQuickMode.addEventListener('click', function() {
        detailedMode.classList.add('d-none');
        quickSelectMode.classList.remove('d-none');
        quickSelectHelp.classList.remove('d-none');
        btnQuickMode.classList.add('d-none');
        btnDetailedMode.classList.remove('d-none');
        expandAllBtn.classList.add('d-none');
        collapseAllBtn.classList.add('d-none');
        
        // Update tabs to match the current tab selection
        if (preSoloTab.classList.contains('active')) {
            document.getElementById('quick-pre-solo').classList.add('show', 'active');
            document.getElementById('quick-post-solo').classList.remove('show', 'active');
        } else {
            document.getElementById('quick-pre-solo').classList.remove('show', 'active');
            document.getElementById('quick-post-solo').classList.add('show', 'active');
        }
    });
    
    btnDetailedMode.addEventListener('click', function() {
        quickSelectMode.classList.add('d-none');
        quickSelectHelp.classList.add('d-none');
        detailedMode.classList.remove('d-none');
        btnDetailedMode.classList.add('d-none');
        btnQuickMode.classList.remove('d-none');
        expandAllBtn.classList.remove('d-none');
        collapseAllBtn.classList.remove('d-none');
    });
    
    // Tab switching - keep pre/post solo tabs in sync between modes
    preSoloTab.addEventListener('click', function() {
        document.getElementById('quick-pre-solo').classList.add('show', 'active');
        document.getElementById('quick-post-solo').classList.remove('show', 'active');
    });
    
    postSoloTab.addEventListener('click', function() {
        document.getElementById('quick-pre-solo').classList.remove('show', 'active');
        document.getElementById('quick-post-solo').classList.add('show', 'active');
    });
    
    // Apply quick selection button
    document.getElementById('apply-quick-select').addEventListener('click', function() {
        // First reset all exercises to "not performed"
        document.querySelectorAll('.exercise-item').forEach(item => {
            const exerciseId = item.getAttribute('data-exercise-id');
            const radioNotPerformed = document.querySelector(`input[type="radio"][value="not_performed"][id$="-not_performed"][name$="-performance"]`, item);
            if (radioNotPerformed) {
                radioNotPerformed.checked = true;
            }
            
            // Update the status badge
            const statusBadge = item.querySelector('.exercise-status');
            if (statusBadge) {
                statusBadge.textContent = 'Not Performed';
                statusBadge.classList.remove('bg-success', 'bg-warning');
                statusBadge.classList.add('bg-secondary');
            }
            
            // Hide notes container
            //const notesContainer = item.querySelector('.notes-container');
            //if (notesContainer) {
            //    notesContainer.classList.add('d-none');
            //}
            
            // Remove any border styling and add not-performed class
            item.classList.remove('border-success', 'border-warning');
            item.classList.add('not-performed');
            
            // Collapse the item
            const content = item.querySelector('.exercise-content');
            if (content) {
                content.classList.add('d-none');
            }
            
            // Update toggle button icon
            const toggleIcon = item.querySelector('.exercise-toggle i');
            if (toggleIcon) {
                toggleIcon.classList.remove('bi-chevron-up');
                toggleIcon.classList.add('bi-chevron-down');
            }
        });
        
        // Then for each checked exercise in quick select, set to "performed_well"
        document.querySelectorAll('.quick-select-checkbox:checked').forEach(checkbox => {
            const exerciseId = checkbox.getAttribute('data-exercise-id');
            const exerciseItem = document.querySelector(`.exercise-item[data-exercise-id="${exerciseId}"]`);
            
            if (exerciseItem) {
                // Find the "performed_well" radio button and check it
                const radioPerformedWell = exerciseItem.querySelector('input[type="radio"][value="performed_well"]');
                if (radioPerformedWell) {
                    radioPerformedWell.checked = true;
                    
                    // Show the exercise details
                    const content = exerciseItem.querySelector('.exercise-content');
                    if (content) {
                        content.classList.remove('d-none');
                    }
                    
                    // Update toggle button icon
                    const toggleIcon = exerciseItem.querySelector('.exercise-toggle i');
                    if (toggleIcon) {
                        toggleIcon.classList.remove('bi-chevron-down');
                        toggleIcon.classList.add('bi-chevron-up');
                    }
                    
                    // Update status badge
                    const statusBadge = exerciseItem.querySelector('.exercise-status');
                    if (statusBadge) {
                        statusBadge.textContent = 'Performed Well';
                        statusBadge.classList.remove('bg-secondary', 'bg-warning');
                        statusBadge.classList.add('bg-success');
                    }
                    
                    // Show notes container
                    //const notesContainer = exerciseItem.querySelector('.notes-container');
                    //if (notesContainer) {
                    //    notesContainer.classList.remove('d-none');
                   // }
                    
                    // Add border styling and remove not-performed class
                    exerciseItem.classList.add('border-success');
                    exerciseItem.classList.remove('not-performed');
                }
            }
        });
        
        // Switch to detailed mode to allow fine-tuning
        quickSelectMode.classList.add('d-none');
        quickSelectHelp.classList.add('d-none');
        detailedMode.classList.remove('d-none');
        btnDetailedMode.classList.add('d-none');
        btnQuickMode.classList.remove('d-none');
        expandAllBtn.classList.remove('d-none');
        collapseAllBtn.classList.remove('d-none');
        
        // Update exercise counter
        updateExerciseCounter();
    });
    
    // Quick select category all/none buttons
    document.querySelectorAll('.select-all-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const target = this.getAttribute('data-target');
            document.querySelectorAll(`.quick-select-checkbox[data-category="${target}"]`).forEach(checkbox => {
                checkbox.checked = true;
            });
        });
    });
    
    document.querySelectorAll('.deselect-all-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const target = this.getAttribute('data-target');
            document.querySelectorAll(`.quick-select-checkbox[data-category="${target}"]`).forEach(checkbox => {
                checkbox.checked = false;
            });
        });
    });
    
    // Exercise search functionality for quick select mode
    searchInput.addEventListener('input', function() {
        const searchText = this.value.toLowerCase();
        
        // Search in both detailed and quick select modes
        document.querySelectorAll('.exercise-item, .exercise-quick-item').forEach(item => {
            const exerciseName = item.getAttribute('data-exercise-name').toLowerCase();
            
            if (exerciseName.includes(searchText)) {
                item.classList.remove('d-none');
            } else {
                item.classList.add('d-none');
            }
        });
    });
    
    // Set up toggle functionality for each exercise
    document.querySelectorAll('.exercise-toggle').forEach(toggle => {
        toggle.addEventListener('click', function() {
            const item = this.closest('.exercise-item');
            const content = item.querySelector('.exercise-content');
            const icon = this.querySelector('i');
            
            if (content.classList.contains('d-none')) {
                // Show content
                content.classList.remove('d-none');
                icon.classList.remove('bi-chevron-down');
                icon.classList.add('bi-chevron-up');
            } else {
                // Hide content
                content.classList.add('d-none');
                icon.classList.remove('bi-chevron-up');
                icon.classList.add('bi-chevron-down');
            }
        });
    });
    
    // Set up radio button change handlers
    document.querySelectorAll('input[type="radio"][name$="-performance"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const item = this.closest('.exercise-item');
            const statusBadge = item.querySelector('.exercise-status');
            //const notesContainer = item.querySelector('.notes-container');
            
            // Update status badge
            if (this.value === 'performed_well') {
                statusBadge.textContent = 'Performed Well';
                statusBadge.classList.remove('bg-secondary', 'bg-warning');
                statusBadge.classList.add('bg-success');
                item.classList.add('border-success');
                item.classList.remove('border-warning', 'not-performed');
                
                //if (notesContainer) notesContainer.classList.remove('d-none');
            } 
            else if (this.value === 'needs_improvement') {
                statusBadge.textContent = 'Needs Improvement';
                statusBadge.classList.remove('bg-secondary', 'bg-success');
                statusBadge.classList.add('bg-warning');
                item.classList.add('border-warning');
                item.classList.remove('border-success', 'not-performed');
                
                //if (notesContainer) notesContainer.classList.remove('d-none');
            }
            else if (this.value === 'performed_badly') {
                statusBadge.textContent = 'Performed Badly';
                statusBadge.classList.remove('bg-secondary', 'bg-success', 'bg-warning');
                statusBadge.classList.add('bg-danger');
                item.classList.add('border-danger');
                item.classList.remove('border-success', 'border-warning', 'not-performed');
            }  
            else {
                statusBadge.textContent = 'Not Performed';
                statusBadge.classList.remove('bg-success', 'bg-warning');
                statusBadge.classList.add('bg-secondary');
                item.classList.remove('border-success', 'border-warning');
                item.classList.add('not-performed');
                
                //if (notesContainer) notesContainer.classList.add('d-none');
            }
            
            // Update counter
            updateExerciseCounter();
        });
    });
    
    // Expand/Collapse All
    if (expandAllBtn) {
        expandAllBtn.addEventListener('click', function() {
            document.querySelectorAll('.exercise-content').forEach(content => {
                content.classList.remove('d-none');
                
                const toggle = content.closest('.exercise-item').querySelector('.exercise-toggle i');
                toggle.classList.remove('bi-chevron-down');
                toggle.classList.add('bi-chevron-up');
            });
        });
    }
    
    if (collapseAllBtn) {
        collapseAllBtn.addEventListener('click', function() {
            document.querySelectorAll('.exercise-content').forEach(content => {
                content.classList.add('d-none');
                
                const toggle = content.closest('.exercise-item').querySelector('.exercise-toggle i');
                toggle.classList.remove('bi-chevron-up');
                toggle.classList.add('bi-chevron-down');
            });
        });
    }
    
    // Exercise counter update
    function updateExerciseCounter() {
        const counter = document.getElementById('exercise-counter');
        const performedExercises = document.querySelectorAll('input[type="radio"][value="performed_well"]:checked, input[type="radio"][value="needs_improvement"]:checked, input[type="radio"][value="performed_badly"]:checked').length;        
        if (counter) {
            counter.textContent = performedExercises;
        }
    }
    
    // Initialize with existing performances
    {% if existing_performances %}
        const performances = {{ existing_performances|safe }};
        
        for (const [exerciseId, data] of Object.entries(performances)) {
            // Find the exercise item
            const item = document.querySelector(`.exercise-item[data-exercise-id="${exerciseId}"]`);
            if (!item) continue;
            
            // Find the correct radio button
            const radio = item.querySelector(`input[value="${data.performance}"]`);
            if (radio) {
                radio.checked = true;
                
                // Trigger the change event
                const event = new Event('change');
                radio.dispatchEvent(event);
                
                // Add or remove not-performed class based on performance
                if (data.performance === 'not_performed') {
                    item.classList.add('not-performed');
                } else {
                    item.classList.remove('not-performed');
                }
                
                // Show the exercise details if performed
                if (data.performance === 'performed_well' || data.performance === 'needs_improvement' || data.performance === 'performed_badly') {
                    const toggle = item.querySelector('.exercise-toggle');
                    const icon = toggle.querySelector('i');
                    const content = item.querySelector('.exercise-content');
                    
                    content.classList.remove('d-none');
                    icon.classList.remove('bi-chevron-down');
                    icon.classList.add('bi-chevron-up');
                    
                    // Remove the not-performed class
                    item.classList.remove('not-performed');
                    
                    // Check the corresponding checkbox in quick select mode
                    const quickCheckbox = document.querySelector(`#quick-select-${exerciseId}`);
                    if (quickCheckbox) {
                        quickCheckbox.checked = true;
                    }
                    
                    // Set notes if any
                    //if (data.notes) {
                    //    const textarea = item.querySelector('textarea');
                    //    if (textarea) {
                    //        textarea.value = data.notes;
                    //    }
                    //}
                }
            }
        }
    {% endif %}
    
    // Initial counter update
    updateExerciseCounter();
});
</script>
{% endblock %}