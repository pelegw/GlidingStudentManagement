{% extends 'base.html' %}
{% load i18n %}
{% block title %}
    {% if object %}
        {% trans "Edit" %}
    {% else %}
        {% trans "New" %}
    {% endif %}
    {% trans "Training Record" %} - {{ CLUB_NAME }}
{% endblock %}

{% block content %}
<div class="container">
    <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">
                {% if object %}
                    {% trans "Edit" %}
                {% else %}
                    {% trans "New" %}
                {% endif %}
                {% trans "Training Record" %}
            </h4>
            <p class="text-light mb-0 small">{% trans "Record details about your flight training session" %}</p>
        </div>
        <div class="card-body">
            <form method="post" id="recordForm">
                {% csrf_token %}
                
                <!-- Flight Information Section -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">{% trans "Flight Information" %}</h5>
                    </div>
                    <div class="card-body">
                        <!-- Instructor selection field -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label for="{{ form.instructor.id_for_label }}" class="form-label">
                                    {% trans "Instructor" %}:
                                </label>
                                {{ form.instructor }}
                                <div class="form-text">{% trans "Select the instructor for this training session" %}</div>
                                {% if form.instructor.errors %}
                                    <div class="text-danger">{{ form.instructor.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Date and duration fields -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="{{ form.date.id_for_label }}" class="form-label">
                                    {% trans "Date" %}:
                                </label>
                                {{ form.date }}
                                {% if form.date.errors %}
                                    <div class="text-danger">{{ form.date.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6">
                                <label for="{{ form.duration_display.id_for_label }}" class="form-label">
                                    {% trans "Flight Duration" %}:
                                </label>
                                <div class="input-group">
                                    {{ form.duration_display }}
                                    <span class="input-group-text">HH:MM</span>
                                </div>
                                {% if form.duration_display.errors %}
                                    <div class="text-danger">{{ form.duration_display.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Glider and tow height fields -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="{{ form.glider.id_for_label }}" class="form-label">
                                    {% trans "Glider" %}:
                                </label>
                                {{ form.glider }}
                                {% if form.glider.errors %}
                                    <div class="text-danger">{{ form.glider.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6">
                                <label for="{{ form.tow_height.id_for_label }}" class="form-label">
                                    {% trans "Tow Height" %}:
                                </label>
                                <div class="input-group">
                                    {{ form.tow_height }}
                                    <span class="input-group-text">feet</span>
                                </div>
                                {% if form.tow_height.errors %}
                                    <div class="text-danger">{{ form.tow_height.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Field/Location -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label for="{{ form.field.id_for_label }}" class="form-label">
                                    {% trans "Field/Location" %}:
                                </label>
                                {{ form.field }}
                                {% if form.field.errors %}
                                    <div class="text-danger">{{ form.field.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Training topic and solo flight -->
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label for="{{ form.training_topic.id_for_label }}" class="form-label">
                                    {% trans "Training Topic" %}:
                                </label>
                                {{ form.training_topic }}
                                {% if form.training_topic.errors %}
                                    <div class="text-danger">{{ form.training_topic.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-4">
                                <div class="form-check mt-4">
                                    {{ form.is_solo }}
                                    <label class="form-check-label" for="{{ form.is_solo.id_for_label }}">
                                        {% trans "Solo Flight" %}
                                    </label>
                                    <div class="form-text">{% trans "No instructor present during the flight" %}</div>
                                    {% if form.is_solo.errors %}
                                        <div class="text-danger">{{ form.is_solo.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Exercises Section -->
                <div class="card mb-4">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            {% trans "Exercises Performed" %}
                            <span id="exercise-counter" class="badge bg-secondary ms-2">0</span>
                        </h5>
                        
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm btn-outline-primary" id="btn-expand-all">Expand All</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-collapse-all">Collapse All</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Navigation tabs for Pre/Post solo exercises -->
                        <ul class="nav nav-tabs mb-3" id="exerciseTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="pre-solo-tab" data-bs-toggle="tab" data-bs-target="#pre-solo-exercises" 
                                        type="button" role="tab" aria-controls="pre-solo-exercises" aria-selected="true">
                                    Pre-Solo ({{ pre_solo_exercises.count }})
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="post-solo-tab" data-bs-toggle="tab" data-bs-target="#post-solo-exercises" 
                                        type="button" role="tab" aria-controls="post-solo-exercises" aria-selected="false">
                                    Post-Solo ({{ post_solo_exercises.count }})
                                </button>
                            </li>
                        </ul>
                        
                        <!-- Search box -->
                        <div class="input-group mb-3">
                            <span class="input-group-text">
                                <i class="bi bi-search"></i>
                            </span>
                            <input type="text" class="form-control" id="exercise-search" placeholder="Search exercises...">
                        </div>
                        
                        <!-- Tab content -->
                        <div class="tab-content" id="exerciseTabContent">
                            <!-- Pre-Solo Exercises Tab -->
                            <div class="tab-pane fade show active" id="pre-solo-exercises" role="tabpanel" aria-labelledby="pre-solo-tab">
                                <div class="list-group">
                                    {% for exercise in pre_solo_exercises %}
                                        <div class="list-group-item list-group-item-action mb-2 exercise-item"
                                             data-exercise-id="{{ exercise.id }}"
                                             data-exercise-name="{{ exercise.name }}">
                                            <div class="d-flex w-100 justify-content-between align-items-center exercise-header">
                                                <h6 class="mb-1">
                                                    {% if exercise.number %}{{ exercise.number }} - {% endif %}{{ exercise.name }}
                                                </h6>
                                                <div>
                                                    <span class="badge exercise-status bg-secondary">Not Performed</span>
                                                    <button type="button" class="btn btn-sm btn-outline-secondary ms-2 exercise-toggle">
                                                        <i class="bi bi-chevron-down"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <div class="exercise-content mt-2" style="display: none;">
                                                <input type="hidden" name="form-{{ forloop.counter0 }}-exercise" value="{{ exercise.id }}">
                                                
                                                <div class="btn-group w-100 mb-3" role="group">
                                                    <input type="radio" class="btn-check" name="form-{{ forloop.counter0 }}-performance" 
                                                           id="form-{{ forloop.counter0 }}-not_performed" value="not_performed" checked>
                                                    <label class="btn btn-outline-secondary" for="form-{{ forloop.counter0 }}-not_performed">
                                                        Not Performed
                                                    </label>
                                                    
                                                    <input type="radio" class="btn-check" name="form-{{ forloop.counter0 }}-performance" 
                                                           id="form-{{ forloop.counter0 }}-needs_improvement" value="needs_improvement">
                                                    <label class="btn btn-outline-warning" for="form-{{ forloop.counter0 }}-needs_improvement">
                                                        Needs Improvement
                                                    </label>
                                                    
                                                    <input type="radio" class="btn-check" name="form-{{ forloop.counter0 }}-performance" 
                                                           id="form-{{ forloop.counter0 }}-performed_well" value="performed_well">
                                                    <label class="btn btn-outline-success" for="form-{{ forloop.counter0 }}-performed_well">
                                                        Performed Well
                                                    </label>
                                                </div>
                                                
                                                <div class="notes-container" style="display: none;">
                                                    <textarea name="form-{{ forloop.counter0 }}-notes" class="form-control" rows="2" 
                                                              placeholder="Optional notes about this exercise"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <!-- Post-Solo Exercises Tab -->
                            <div class="tab-pane fade" id="post-solo-exercises" role="tabpanel" aria-labelledby="post-solo-tab">
                                <div class="list-group">
                                    {% for exercise in post_solo_exercises %}
                                        <div class="list-group-item list-group-item-action mb-2 exercise-item"
                                             data-exercise-id="{{ exercise.id }}"
                                             data-exercise-name="{{ exercise.name }}">
                                            <div class="d-flex w-100 justify-content-between align-items-center exercise-header">
                                                <h6 class="mb-1">
                                                    {% if exercise.number %}{{ exercise.number }} - {% endif %}{{ exercise.name }}
                                                </h6>
                                                <div>
                                                    <span class="badge exercise-status bg-secondary">Not Performed</span>
                                                    <button type="button" class="btn btn-sm btn-outline-secondary ms-2 exercise-toggle">
                                                        <i class="bi bi-chevron-down"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <div class="exercise-content mt-2" style="display: none;">
                                                <input type="hidden" name="form-{{ forloop.counter0|add:pre_solo_exercises.count }}-exercise" value="{{ exercise.id }}">
                                                
                                                <div class="btn-group w-100 mb-3" role="group">
                                                    <input type="radio" class="btn-check" name="form-{{ forloop.counter0|add:pre_solo_exercises.count }}-performance" 
                                                           id="form-{{ forloop.counter0|add:pre_solo_exercises.count }}-not_performed" value="not_performed" checked>
                                                    <label class="btn btn-outline-secondary" for="form-{{ forloop.counter0|add:pre_solo_exercises.count }}-not_performed">
                                                        Not Performed
                                                    </label>
                                                    
                                                    <input type="radio" class="btn-check" name="form-{{ forloop.counter0|add:pre_solo_exercises.count }}-performance" 
                                                           id="form-{{ forloop.counter0|add:pre_solo_exercises.count }}-needs_improvement" value="needs_improvement">
                                                    <label class="btn btn-outline-warning" for="form-{{ forloop.counter0|add:pre_solo_exercises.count }}-needs_improvement">
                                                        Needs Improvement
                                                    </label>
                                                    
                                                    <input type="radio" class="btn-check" name="form-{{ forloop.counter0|add:pre_solo_exercises.count }}-performance" 
                                                           id="form-{{ forloop.counter0|add:pre_solo_exercises.count }}-performed_well" value="performed_well">
                                                    <label class="btn btn-outline-success" for="form-{{ forloop.counter0|add:pre_solo_exercises.count }}-performed_well">
                                                        Performed Well
                                                    </label>
                                                </div>
                                                
                                                <div class="notes-container" style="display: none;">
                                                    <textarea name="form-{{ forloop.counter0|add:pre_solo_exercises.count }}-notes" class="form-control" rows="2" 
                                                              placeholder="Optional notes about this exercise"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Management form fields for formset -->
                        <input type="hidden" name="form-TOTAL_FORMS" value="{{ pre_solo_exercises.count|add:post_solo_exercises.count }}">
                        <input type="hidden" name="form-INITIAL_FORMS" value="0">
                        <input type="hidden" name="form-MIN_NUM_FORMS" value="0">
                        <input type="hidden" name="form-MAX_NUM_FORMS" value="1000">
                    </div>
                </div>
                
                <!-- Comments Section -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">{% trans "Comments" %}</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="{{ form.student_comments.id_for_label }}" class="form-label">
                                {% trans "Student Comments" %}:
                            </label>
                            {{ form.student_comments }}
                            {% if form.student_comments.errors %}
                                <div class="text-danger">{{ form.student_comments.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Form errors -->
                {% if form.errors %}
                    <div class="alert alert-danger">
                        <p><strong>Please correct the following errors:</strong></p>
                        <ul>
                            {% for field in form %}
                                {% for error in field.errors %}
                                    <li>{{ field.label }}: {{ error }}</li>
                                {% endfor %}
                            {% endfor %}
                            {% for error in form.non_field_errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}
                
                <!-- Submit buttons -->
                <div class="d-flex justify-content-between">
                    <a href="{% url 'record_list' %}" class="btn btn-secondary">{% trans "Cancel" %}</a>
                    <button type="submit" class="btn btn-primary">
                        {% if object %}
                            {% trans "Save Changes" %}
                        {% else %}
                            {% trans "Create Record" %}
                        {% endif %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Counters and elements
    let selectedExercises = 0;
    const counter = document.getElementById('exercise-counter');
    const exerciseItems = document.querySelectorAll('.exercise-item');
    const searchInput = document.getElementById('exercise-search');
    const expandAllBtn = document.getElementById('btn-expand-all');
    const collapseAllBtn = document.getElementById('btn-collapse-all');
    
    // Set up toggle functionality for each exercise
    document.querySelectorAll('.exercise-toggle').forEach(toggle => {
        toggle.addEventListener('click', function() {
            const item = this.closest('.exercise-item');
            const content = item.querySelector('.exercise-content');
            const icon = this.querySelector('i');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.classList.remove('bi-chevron-down');
                icon.classList.add('bi-chevron-up');
            } else {
                content.style.display = 'none';
                icon.classList.remove('bi-chevron-up');
                icon.classList.add('bi-chevron-down');
            }
        });
    });
    
    // Set up radio button change handlers
    document.querySelectorAll('input[type="radio"][name$="-performance"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const item = this.closest('.exercise-item');
            const statusBadge = item.querySelector('.exercise-status');
            const notesContainer = item.querySelector('.notes-container');
            
            // Update status badge
            if (this.value === 'performed_well') {
                statusBadge.textContent = 'Performed Well';
                statusBadge.className = 'badge exercise-status bg-success';
                item.classList.add('border-success');
                item.classList.remove('border-warning');
                
                if (notesContainer) notesContainer.style.display = 'block';
            } 
            else if (this.value === 'needs_improvement') {
                statusBadge.textContent = 'Needs Improvement';
                statusBadge.className = 'badge exercise-status bg-warning';
                item.classList.add('border-warning');
                item.classList.remove('border-success');
                
                if (notesContainer) notesContainer.style.display = 'block';
            } 
            else {
                statusBadge.textContent = 'Not Performed';
                statusBadge.className = 'badge exercise-status bg-secondary';
                item.classList.remove('border-success', 'border-warning');
                
                if (notesContainer) notesContainer.style.display = 'none';
            }
            
            // Update counter
            updateExerciseCounter();
        });
    });
    
    // Search functionality
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const searchText = this.value.toLowerCase();
            
            exerciseItems.forEach(item => {
                const exerciseName = item.getAttribute('data-exercise-name').toLowerCase();
                
                if (exerciseName.includes(searchText)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    }
    
    // Expand/Collapse All
    if (expandAllBtn) {
        expandAllBtn.addEventListener('click', function() {
            document.querySelectorAll('.exercise-content').forEach(content => {
                content.style.display = 'block';
                
                const toggle = content.closest('.exercise-item').querySelector('.exercise-toggle i');
                toggle.classList.remove('bi-chevron-down');
                toggle.classList.add('bi-chevron-up');
            });
        });
    }
    
    if (collapseAllBtn) {
        collapseAllBtn.addEventListener('click', function() {
            document.querySelectorAll('.exercise-content').forEach(content => {
                content.style.display = 'none';
                
                const toggle = content.closest('.exercise-item').querySelector('.exercise-toggle i');
                toggle.classList.remove('bi-chevron-up');
                toggle.classList.add('bi-chevron-down');
            });
        });
    }
    
    // Exercise counter update
    function updateExerciseCounter() {
        const performedExercises = document.querySelectorAll('input[type="radio"][value="performed_well"]:checked, input[type="radio"][value="needs_improvement"]:checked').length;
        
        if (counter) {
            counter.textContent = performedExercises;
        }
    }
    
    // Initialize with existing performances
    {% if existing_performances %}
        const performances = {{ existing_performances|safe }};
        
        for (const [exerciseId, data] of Object.entries(performances)) {
            // Find the exercise item
            const item = document.querySelector(`.exercise-item[data-exercise-id="${exerciseId}"]`);
            if (!item) continue;
            
            // Find the correct radio button
            const radio = item.querySelector(`input[value="${data.performance}"]`);
            if (radio) {
                radio.checked = true;
                
                // Trigger the change event
                const event = new Event('change');
                radio.dispatchEvent(event);
                
                // Show the exercise details
                if (data.performance === 'performed_well' || data.performance === 'needs_improvement') {
                    const toggle = item.querySelector('.exercise-toggle');
                    const icon = toggle.querySelector('i');
                    const content = item.querySelector('.exercise-content');
                    
                    content.style.display = 'block';
                    icon.classList.remove('bi-chevron-down');
                    icon.classList.add('bi-chevron-up');
                    
                    // Set notes if any
                    if (data.notes) {
                        const textarea = item.querySelector('textarea');
                        if (textarea) {
                            textarea.value = data.notes;
                        }
                    }
                }
            }
        }
    {% endif %}
    
    // Initial counter update
    updateExerciseCounter();
});
</script>
{% endblock %}